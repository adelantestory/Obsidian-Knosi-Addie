/*
Vault RAG Sync Plugin for Obsidian
*/

var E=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var I=(g,a)=>{for(var e in a)E(g,e,{get:a[e],enumerable:!0})},P=(g,a,e,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let s of $(a))!C.call(g,s)&&s!==e&&E(g,s,{get:()=>a[s],enumerable:!(t=k(a,s))||t.enumerable});return g};var T=g=>P(E({},"__esModule",{value:!0}),g);var N={};I(N,{default:()=>v});module.exports=T(N);var i=require("obsidian"),F={serverUrl:"http://localhost:48550",apiKey:"",autoSync:!0,syncOnStartup:!0,syncIntervalMinutes:10,supportedExtensions:[".md",".txt",".pdf",".html",".htm",".org",".rst",".png",".jpg",".jpeg",".gif",".webp"],excludePatterns:[".obsidian/",".trash/","Templates/"],verboseLogging:!1},S="knosi-chat-view",v=class extends i.Plugin{constructor(){super(...arguments);this.syncInProgress=!1;this.pendingUploads=new Set;this.pendingDeletes=new Set;this.currentlyProcessing=new Set;this.syncIntervalId=null}async onload(){await this.loadSettings(),this.registerView(S,e=>new x(e,this)),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("idle"),this.addCommand({id:"sync-current-file",name:"Sync current file (immediate)",callback:()=>this.syncCurrentFile()}),this.addCommand({id:"sync-queue-now",name:"Process sync queue now",callback:()=>this.processQueue()}),this.addCommand({id:"sync-all-files",name:"Sync all files",callback:()=>this.syncAllFiles()}),this.addCommand({id:"check-server-status",name:"Check server status",callback:()=>this.checkServerStatus()}),this.addCommand({id:"view-queue",name:"View pending sync queue",callback:()=>this.viewQueue()}),this.addCommand({id:"open-chat",name:"Open chat",callback:()=>this.activateChatView()}),this.addRibbonIcon("message-square","Knosi Chat",()=>{this.activateChatView()}),this.addSettingTab(new b(this.app,this)),setTimeout(()=>{this.settings.syncOnStartup&&this.syncAllFiles(),this.settings.autoSync&&(this.registerEvent(this.app.vault.on("create",e=>this.queueFileUpload(e))),this.registerEvent(this.app.vault.on("modify",e=>this.queueFileUpload(e))),this.registerEvent(this.app.vault.on("delete",e=>this.queueFileDelete(e))),this.registerEvent(this.app.vault.on("rename",(e,t)=>this.handleFileRename(e,t))),this.startSyncInterval())},5e3),console.log("Knosi plugin loaded")}onunload(){this.stopSyncInterval(),this.pendingUploads.clear(),this.pendingDeletes.clear(),console.log("Knosi Sync plugin unloaded")}async loadSettings(){this.settings=Object.assign({},F,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async saveSettingsAndRescan(e){await this.saveData(this.settings);let t=this.settings.supportedExtensions;JSON.stringify(e)!==JSON.stringify(t)&&this.rescanVaultForNewExtensions(e,t)}async saveSettingsAndRescanExclusions(e){await this.saveData(this.settings);let t=this.settings.excludePatterns;JSON.stringify(e)!==JSON.stringify(t)&&this.rescanVaultForNewExclusions(e,t)}rescanVaultForNewExtensions(e,t){let s=t.filter(r=>!e.includes(r));if(s.length===0)return;this.settings.verboseLogging&&console.log(`Rescanning vault for new extensions: ${s.join(", ")}`),new i.Notice(`Rescanning vault for: ${s.join(", ")}`);let n=this.app.vault.getFiles(),o=0;for(let r of n){let l="."+r.extension.toLowerCase();s.includes(l)&&!this.isExcluded(r.path)&&(this.pendingUploads.add(r.path),o++)}o>0?(this.settings.verboseLogging&&console.log(`Queued ${o} files for sync`),new i.Notice(`Queued ${o} files for sync`),this.updateStatusBar("pending")):new i.Notice("No new files found to sync")}rescanVaultForNewExclusions(e,t){let s=t.filter(r=>!e.includes(r));if(s.length===0)return;this.settings.verboseLogging&&console.log(`Rescanning vault for newly excluded patterns: ${s.join(", ")}`),new i.Notice(`Finding files to delete for: ${s.join(", ")}`);let n=this.app.vault.getFiles(),o=0;for(let r of n)for(let l of s){if(!l.trim())continue;let d=!1;if(l.endsWith("/"))(r.path.startsWith(l)||r.path.includes("/"+l))&&(d=!0);else if(l.includes("*")){let c=l.replace(/\./g,"\\.").replace(/\*\*/g,".*").replace(/\*/g,"[^/]*");new RegExp("^"+c+"$").test(r.path)&&(d=!0)}else((r.path.split("/").pop()||"")===l||r.path===l||r.path.endsWith("/"+l))&&(d=!0);if(d){this.pendingUploads.delete(r.path),this.pendingDeletes.add(r.path),o++;break}}o>0?(this.settings.verboseLogging&&console.log(`Queued ${o} files for deletion`),new i.Notice(`Queued ${o} files for deletion from server`),this.updateStatusBar("pending")):new i.Notice("No matching files found to delete")}startSyncInterval(){this.stopSyncInterval();let e=this.settings.syncIntervalMinutes*60*1e3;this.syncIntervalId=window.setInterval(()=>this.processQueue(),e),this.settings.verboseLogging&&console.log(`Sync interval started: every ${this.settings.syncIntervalMinutes} minute(s)`)}stopSyncInterval(){this.syncIntervalId!==null&&(window.clearInterval(this.syncIntervalId),this.syncIntervalId=null)}restartSyncInterval(){this.startSyncInterval()}updateStatusBar(e,t){let n=`${{idle:"\u{1F52E}",pending:"\u{1F550}",syncing:"\u{1F504}",success:"\u2705",error:"\u274C"}[e]} Knosi`;e==="pending"&&this.pendingUploads.size>0?n+=` (${this.pendingUploads.size})`:t&&(n+=`: ${t}`),this.statusBarItem.setText(n)}isSupportedFile(e){if(!(e instanceof i.TFile))return!1;let t="."+e.extension.toLowerCase();return this.settings.supportedExtensions.includes(t)}isExcluded(e){for(let t of this.settings.excludePatterns)if(t.trim()){if(t.endsWith("/")){if(e.startsWith(t)||e.includes("/"+t))return!0}else if(t.includes("*")){let s=t.replace(/\./g,"\\.").replace(/\*\*/g,".*").replace(/\*/g,"[^/]*");if(new RegExp("^"+s+"$").test(e))return!0}else if((e.split("/").pop()||"")===t||e===t||e.endsWith("/"+t))return!0}return!1}queueFileUpload(e){if(this.isSupportedFile(e)){if(this.isExcluded(e.path)){this.settings.verboseLogging&&console.log(`Skipping excluded file: ${e.path}`);return}this.pendingDeletes.delete(e.path),this.pendingUploads.add(e.path),this.updateStatusBar("pending"),this.settings.verboseLogging&&console.log(`Queued for sync: ${e.path} (${this.pendingUploads.size} in queue)`)}}queueFileDelete(e){if(!(e instanceof i.TFile))return;let t="."+e.extension.toLowerCase();this.settings.supportedExtensions.includes(t)&&(this.pendingUploads.delete(e.path),this.pendingDeletes.add(e.path),this.updateStatusBar("pending"),this.settings.verboseLogging&&console.log(`Queued for delete: ${e.path}`))}handleFileRename(e,t){this.isSupportedFile(e)&&(this.pendingDeletes.add(t),this.pendingUploads.delete(t),this.pendingUploads.add(e.path),this.pendingDeletes.delete(e.path),this.updateStatusBar("pending"))}async processQueue(){if(this.syncInProgress){this.settings.verboseLogging&&console.log("Sync already in progress, skipping");return}let e=new Set(this.pendingUploads),t=new Set(this.pendingDeletes);if(e.size===0&&t.size===0)return;this.syncInProgress=!0,this.currentlyProcessing=new Set([...e,...t]),this.updateStatusBar("syncing",`${e.size} files`),this.settings.verboseLogging&&console.log(`Processing queue: ${e.size} uploads, ${t.size} deletes`);let s=0,n=0,o=0;for(let r of t)try{await this.deleteFileByPath(r),this.pendingDeletes.delete(r),this.currentlyProcessing.delete(r),n++}catch(l){o++,this.currentlyProcessing.delete(r)}for(let r of e){let l=this.app.vault.getAbstractFileByPath(r);if(l instanceof i.TFile)try{await this.uploadFile(l),this.pendingUploads.delete(r),this.currentlyProcessing.delete(r),s++}catch(d){o++,this.currentlyProcessing.delete(r)}else this.pendingUploads.delete(r),this.currentlyProcessing.delete(r)}this.syncInProgress=!1,this.currentlyProcessing.clear(),o>0?(this.updateStatusBar("error",`${o} failed`),setTimeout(()=>this.updateStatusBar("idle"),5e3)):s>0||n>0?(this.updateStatusBar("success"),setTimeout(()=>{this.pendingUploads.size>0?this.updateStatusBar("pending"):this.updateStatusBar("idle")},2e3)):this.updateStatusBar("idle"),this.settings.verboseLogging&&console.log(`Queue processed: ${s} uploaded, ${n} deleted, ${o} errors`)}viewQueue(){let e=Array.from(this.currentlyProcessing),t=Array.from(this.pendingUploads),s=Array.from(this.pendingDeletes);if(e.length===0&&t.length===0&&s.length===0){new i.Notice("Sync queue is empty");return}let n="";e.length>0&&(n+=`\u23F3 Currently processing (${e.length}):
${e.slice(0,10).join(`
`)}`,e.length>10&&(n+=`
...and ${e.length-10} more`)),t.length>0&&(n&&(n+=`

`),n+=`\u{1F4E4} Pending uploads (${t.length}):
${t.slice(0,10).join(`
`)}`,t.length>10&&(n+=`
...and ${t.length-10} more`)),s.length>0&&(n&&(n+=`

`),n+=`\u{1F5D1}\uFE0F Pending deletes (${s.length}):
${s.slice(0,10).join(`
`)}`,s.length>10&&(n+=`
...and ${s.length-10} more`)),new i.Notice(n,1e4)}async uploadFile(e){try{let t=await this.app.vault.readBinary(e);if(t.byteLength===0){this.settings.verboseLogging&&console.log(`Skipping empty file: ${e.path}`);return}let s=new Blob([t]),n=new FormData;n.append("file",s,e.name),n.append("path",e.path),n.append("vault_name",this.app.vault.getName());let o=await fetch(`${this.settings.serverUrl}/api/upload`,{method:"POST",headers:{"X-API-Key":this.settings.apiKey},body:n});if(!o.ok){let l=await o.json();throw new Error(l.detail||`HTTP ${o.status}`)}let r=await o.json();this.settings.verboseLogging&&console.log(`Synced: ${e.path} (${r.status})`)}catch(t){throw console.error(`Failed to sync ${e.path}:`,t),t}}async deleteFileByPath(e){try{let t=this.app.vault.getName(),s=new URL(`${this.settings.serverUrl}/api/documents/${encodeURIComponent(e)}`);s.searchParams.set("vault_name",t),(await fetch(s.toString(),{method:"DELETE",headers:{"X-API-Key":this.settings.apiKey}})).ok&&this.settings.verboseLogging&&console.log(`Deleted from index: ${e}`)}catch(t){throw console.error(`Failed to delete ${e}:`,t),t}}async syncCurrentFile(){let e=this.app.workspace.getActiveFile();if(!e){new i.Notice("No file is currently open");return}if(!this.isSupportedFile(e)){new i.Notice(`File type .${e.extension} is not supported`);return}this.updateStatusBar("syncing",e.name);try{await this.uploadFile(e),this.updateStatusBar("success"),new i.Notice(`Synced: ${e.name}`)}catch(t){this.updateStatusBar("error",e.name),new i.Notice(`Failed to sync: ${t.message}`)}setTimeout(()=>this.updateStatusBar("idle"),2e3)}async syncAllFiles(){if(this.syncInProgress){new i.Notice("Sync already in progress");return}this.syncInProgress=!0,this.updateStatusBar("syncing","all files");let e=this.app.vault.getFiles().filter(n=>this.isSupportedFile(n)&&!this.isExcluded(n.path)),t=0,s=0;new i.Notice(`Syncing ${e.length} files...`),this.currentlyProcessing=new Set(e.map(n=>n.path));for(let n of e)try{await this.uploadFile(n),this.currentlyProcessing.delete(n.path),t++}catch(o){this.currentlyProcessing.delete(n.path),s++}this.syncInProgress=!1,this.currentlyProcessing.clear(),this.updateStatusBar("idle"),new i.Notice(`Sync complete: ${t} files synced${s>0?`, ${s} errors`:""}`)}async activateChatView(){let{workspace:e}=this.app,t=null,s=e.getLeavesOfType(S);s.length>0?t=s[0]:(t=e.getRightLeaf(!1),await(t==null?void 0:t.setViewState({type:S,active:!0}))),t&&e.revealLeaf(t)}async checkServerStatus(){try{let e=await fetch(`${this.settings.serverUrl}/api/status`,{headers:{"X-API-Key":this.settings.apiKey}});if(!e.ok){e.status===401?new i.Notice("\u274C Authentication failed - check API key"):new i.Notice(`\u274C Server error: ${e.status}`);return}let t=await e.json();new i.Notice(`\u2705 Connected: ${t.document_count} documents, ${t.chunk_count} chunks`)}catch(e){new i.Notice(`\u274C Cannot connect to server: ${e.message}`)}}},x=class extends i.ItemView{constructor(a,e){super(a),this.plugin=e}getViewType(){return S}getDisplayText(){return"Knosi Chat"}getIcon(){return"message-square"}async onOpen(){let a=this.containerEl.children[1];a.empty(),a.addClass("knosi-chat-container"),a.createEl("div",{cls:"knosi-chat-header"}).createEl("h4",{text:"Chat with your documents"}),this.messagesContainer=a.createEl("div",{cls:"knosi-chat-messages"}),this.inputContainer=a.createEl("div",{cls:"knosi-chat-input-container"}),this.inputEl=this.inputContainer.createEl("textarea",{cls:"knosi-chat-input",attr:{placeholder:"Ask a question about your documents...",rows:"3"}}),this.sendButton=this.inputContainer.createEl("button",{cls:"knosi-chat-send-button",text:"Send"}),this.sendButton.addEventListener("click",()=>this.sendMessage()),this.inputEl.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.sendMessage())}),this.addMessage("assistant","Hello! Ask me anything about your documents. I'll search through your knowledge base and provide answers with sources.")}async onClose(){}addMessage(a,e,t){let s=this.messagesContainer.createEl("div",{cls:`knosi-chat-message knosi-chat-message-${a}`}),n=s.createEl("div",{cls:"knosi-chat-message-content"}),o=e.split(`
`),r=!1;if(o.forEach((l,d)=>{let c=l.match(/^(#{2,3})\s+(.+)$/);if(c){let y=c[1].length,p=c[2],f=n.createEl(`h${y}`,{cls:"knosi-chat-header-text"});p.split(/\*\*(.+?)\*\*/g).forEach((u,h)=>{h%2===1?f.createEl("strong",{text:u}):u&&f.appendText(u)}),r=!0}else l.trim()?(d>0&&!r&&n.createEl("br"),l.split(/\*\*(.+?)\*\*/g).forEach((p,f)=>{f%2===1?n.createEl("strong",{text:p}):p&&n.appendText(p)}),r=!1):(r||d>0&&n.createEl("br"),r=!1)}),t&&t.length>0){let l=s.createEl("div",{cls:"knosi-chat-sources"});l.createEl("strong",{text:"Sources:"});let d=l.createEl("ul",{cls:"knosi-chat-sources-list"});t.forEach(c=>{let y=d.createEl("li"),p=y.createEl("a",{text:c.filename,cls:"knosi-chat-source-link",href:"#"}),f=this.plugin.app.vault.getName();if(c.source_type==="vault"&&c.vault_name&&c.vault_name!==f){let w=y.createEl("span",{text:` (from "${c.vault_name}")`,cls:"knosi-source-vault-indicator"})}p.addEventListener("click",async w=>{if(w.preventDefault(),c.source_type==="vault")if(c.vault_name&&c.vault_name!==f){let u=`${this.plugin.settings.serverUrl}/api/documents/${encodeURIComponent(c.filename)}/download?api_key=${encodeURIComponent(this.plugin.settings.apiKey)}&vault_name=${encodeURIComponent(c.vault_name)}&inline=true`,h=this.plugin.app.workspace.getLeaf("tab");await h.setViewState({type:"empty",state:{}});let m=h.view.containerEl;m.empty(),m.createEl("iframe",{attr:{src:u,style:"width: 100%; height: 100%; border: none;"}})}else{let u=this.plugin.app.vault.getAbstractFileByPath(c.filename);u instanceof i.TFile?await this.plugin.app.workspace.getLeaf("tab").openFile(u):new i.Notice(`File not found in vault: ${c.filename}`)}else{let u=`${this.plugin.settings.serverUrl}/api/documents/${encodeURIComponent(c.filename)}/download?api_key=${encodeURIComponent(this.plugin.settings.apiKey)}&inline=true`,h=this.plugin.app.workspace.getLeaf("tab");await h.setViewState({type:"empty",state:{}});let m=h.view.containerEl;m.empty(),m.createEl("iframe",{attr:{src:u,style:"width: 100%; height: 100%; border: none;"}})}})})}this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}async sendMessage(){let a=this.inputEl.value.trim();if(!a)return;this.inputEl.value="",this.addMessage("user",a);let e=this.messagesContainer.createEl("div",{cls:"knosi-chat-message knosi-chat-message-assistant knosi-chat-loading"});e.createEl("div",{cls:"knosi-chat-message-content",text:"Thinking..."});try{let t=await fetch(`${this.plugin.settings.serverUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.plugin.settings.apiKey},body:JSON.stringify({message:a})});if(!t.ok)throw new Error(`HTTP ${t.status}`);let s=await t.json();e.remove(),this.addMessage("assistant",s.response,s.sources)}catch(t){e.remove(),this.addMessage("assistant",`Error: ${t.message}`),console.error("Chat error:",t)}}},b=class extends i.PluginSettingTab{constructor(a,e){super(a,e),this.plugin=e}display(){let{containerEl:a}=this;a.empty(),this.originalSettings=JSON.parse(JSON.stringify(this.plugin.settings)),this.tempSettings=JSON.parse(JSON.stringify(this.plugin.settings)),a.createEl("h1",{text:"Knosi"}),new i.Setting(a).setName("Server URL").setDesc("URL of your Knosi API server").addText(e=>e.setPlaceholder("http://localhost:48550").setValue(this.tempSettings.serverUrl).onChange(t=>{this.tempSettings.serverUrl=t})),new i.Setting(a).setName("API Key").setDesc("API key for authentication (if required)").addText(e=>{e.setPlaceholder("Enter API key").setValue(this.tempSettings.apiKey).onChange(t=>{this.tempSettings.apiKey=t}),e.inputEl.type="password"}),new i.Setting(a).setName("Auto-sync").setDesc("Automatically queue files for sync when created or modified (requires Obsidian restart)").addToggle(e=>e.setValue(this.tempSettings.autoSync).onChange(t=>{this.tempSettings.autoSync=t})),new i.Setting(a).setName("Sync interval (minutes)").setDesc("How often to process the sync queue if auto-sync is enabled (1-60 minutes). Lower = more frequent syncs, higher = fewer API calls. (Default: 10 minutes)").addSlider(e=>e.setLimits(1,60,1).setValue(this.tempSettings.syncIntervalMinutes).setDynamicTooltip().onChange(t=>{this.tempSettings.syncIntervalMinutes=t})).addExtraButton(e=>e.setIcon("reset").setTooltip("Reset to default (10 minutes)").onClick(()=>{this.tempSettings.syncIntervalMinutes=1,this.display()})),new i.Setting(a).setName("Sync on startup").setDesc("Sync all files when Obsidian opens").addToggle(e=>e.setValue(this.tempSettings.syncOnStartup).onChange(t=>{this.tempSettings.syncOnStartup=t})),new i.Setting(a).setName("Supported extensions").setDesc("File extensions to sync (comma-separated). Changes will trigger a rescan when saved.").addText(e=>e.setPlaceholder(".md, .txt, .pdf").setValue(this.tempSettings.supportedExtensions.join(", ")).onChange(t=>{this.tempSettings.supportedExtensions=t.split(",").map(s=>s.trim().toLowerCase()).filter(s=>s.startsWith("."))})),new i.Setting(a).setName("Exclude patterns").setDesc("Paths/files to exclude (comma-separated). Supports directories (end with /), filenames, or glob patterns (*). Adding new patterns will delete matching files from server when saved.").addTextArea(e=>{e.setPlaceholder(".obsidian/, Templates/, *.tmp, **/*.backup").setValue(this.tempSettings.excludePatterns.join(", ")).onChange(t=>{this.tempSettings.excludePatterns=t.split(",").map(s=>s.trim()).filter(s=>s.length>0)}),e.inputEl.rows=3}),new i.Setting(a).setName("Verbose logging").setDesc("Log all sync operations to console. When disabled, only errors are logged.").addToggle(e=>e.setValue(this.tempSettings.verboseLogging).onChange(t=>{this.tempSettings.verboseLogging=t})),new i.Setting(a).addButton(e=>e.setButtonText("Save").setCta().onClick(async()=>{await this.saveSettings()})),a.createEl("h3",{text:"Actions"}),new i.Setting(a).setName("Test connection").setDesc("Check if the server is reachable").addButton(e=>e.setButtonText("Test").onClick(()=>this.plugin.checkServerStatus())),new i.Setting(a).setName("View sync queue").setDesc("Show files pending sync").addButton(e=>e.setButtonText("View Queue").onClick(()=>this.plugin.viewQueue())),new i.Setting(a).setName("Process queue now").setDesc("Sync all pending files immediately").addButton(e=>e.setButtonText("Sync Now").onClick(()=>this.plugin.processQueue())),new i.Setting(a).setName("Sync all files").setDesc("Upload all supported files to the server (bypasses queue)").addButton(e=>e.setButtonText("Sync All").setCta().onClick(()=>this.plugin.syncAllFiles()))}async saveSettings(){let a=JSON.stringify(this.originalSettings.supportedExtensions)!==JSON.stringify(this.tempSettings.supportedExtensions),e=JSON.stringify(this.originalSettings.excludePatterns)!==JSON.stringify(this.tempSettings.excludePatterns),t=this.originalSettings.syncIntervalMinutes!==this.tempSettings.syncIntervalMinutes,s=this.originalSettings.autoSync!==this.tempSettings.autoSync;if(this.plugin.settings=JSON.parse(JSON.stringify(this.tempSettings)),await this.plugin.saveData(this.plugin.settings),t&&this.plugin.restartSyncInterval(),s&&new i.Notice("Restart Obsidian for auto-sync changes to take effect"),a){let n=this.originalSettings.supportedExtensions,o=this.tempSettings.supportedExtensions;this.plugin.rescanVaultForNewExtensions(n,o)}if(e){let n=this.originalSettings.excludePatterns,o=this.tempSettings.excludePatterns;this.plugin.rescanVaultForNewExclusions(n,o)}new i.Notice("Settings saved"),this.originalSettings=JSON.parse(JSON.stringify(this.tempSettings))}};
