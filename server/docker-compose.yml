services:
  # PostgreSQL with pgvector
  db:
    image: pgvector/pgvector:pg16
    container_name: knosi-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=knosi
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=knosi
    volumes:
      # If POSTGRES_DATA_PATH is set, use it; otherwise use named volume
      - ${POSTGRES_DATA_PATH:-knosi_pgdata}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U knosi -d knosi"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Python FastAPI Backend
  api:
    build: ./api
    container_name: knosi-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-48550}:8000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - API_SECRET_KEY=${API_SECRET_KEY}
      - DATABASE_URL=postgresql+asyncpg://knosi:${POSTGRES_PASSWORD}@db:5432/knosi
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-100}
      - CHUNK_SIZE=${CHUNK_SIZE:-4000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - AZURE_OPENAI_EMBEDDING_DEPLOYMENT=${AZURE_OPENAI_EMBEDDING_DEPLOYMENT}
      - AZURE_OPENAI_API_VERSION=${AZURE_OPENAI_API_VERSION:-2024-02-01}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-1536}

      - PDF_BATCH_SIZE=${PDF_BATCH_SIZE:-20}
      - PDF_BATCHES_PER_MINUTE=${PDF_BATCHES_PER_MINUTE:-60}
      - PDF_MAX_BATCHES=${PDF_MAX_BATCHES:-}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # React Frontend
  web:
    build:
      context: ./web
      args:
        VITE_API_URL: ${SERVER_URL:-http://localhost}:${API_PORT:-48550}
    container_name: knosi-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-48080}:80"
    depends_on:
      - api

volumes:
  knosi_pgdata:
